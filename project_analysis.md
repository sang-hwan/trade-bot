# 📘 나의 자동 투자 시스템 이해하기 (`project_analysis.md`)

## 🧩 1. 이 프로젝트는 뭐 하는 건가요?

이건 **“스스로 사고파는 투자 로봇”**이에요.
사람이 매일 차트를 보며 사고팔 필요 없이,
로봇이 **데이터를 보고 판단 → 가상으로 연습 → 진짜로 거래**하는 일을 합니다.

---

## 🧱 2. 로봇의 몸 구조

로봇은 5개의 몸통으로 나뉘어 있어요:

| 단계 | 이름                    | 하는 일                                 |
| -- | --------------------- | ------------------------------------ |
| ①  | **데이터(Data)**         | 세상에서 돈 정보(주식, 코인 시세)를 모아와서 깨끗하게 정리   |
| ②  | **전략(Strategy)**      | “언제 사고, 언제 팔지” 규칙을 만듦                |
| ③  | **시뮬레이션(Simulation)** | 과거 데이터를 이용해 “이 규칙이 잘 먹히는지” 연습해봄      |
| ④  | **검증(Validation)**    | 데이터나 계산이 틀린 게 없는지 꼼꼼히 검사             |
| ⑤  | **실매매(Live)**         | 진짜 증권사(KIS)나 거래소(Upbit)랑 연결해 실제로 주문함 |

---

## 🔍 3. 각 단계 자세히 보기

### 🧮 (1) 데이터 단계 — **“세상 정보를 깨끗하게 모으기”**

1. **`collect.py`**

   * Yahoo나 Upbit에서 **가격 데이터를 가져옴**
   * 날짜를 **세계시간(UTC)** 기준으로 통일
2. **`quality_gate.py`**

   * “시간이 거꾸로 됐나요?”, “가격이 음수인가요?” 같은 문제 검사
3. **`adjust.py`**

   * 주식이 분할되거나 배당이 생기면 **가격을 자동 보정**
4. **`snapshot.py`**

   * 데이터를 저장하고 **‘이 버전은 수정 안 돼요!’라는 증명서(SHA-256)** 붙임
5. **`universe.py`**

   * **오늘 거래 가능한 종목 목록** 만들기 (예: AAPL, BTC, 삼성전자 등)

🟢 요약: “세상 정보를 깨끗하게, 다시 볼 때도 똑같이” 만드는 단계예요.

---

### 🧭 (2) 전략 단계 — **“판단 기준 세우기”**

1. **`features.py`**

   * 이동평균(SMA)이나 저점선(Donchian) 같은 **보조선** 계산
2. **`signals.py`**

   * “이 선이 저 선을 넘으면 사자!” 같은 **매수 신호** 계산
3. **`stops.py`**

   * “이 가격 밑으로 떨어지면 손절!” 같은 **매도 스톱** 계산
4. **`sizing_spec.py`**

   * “한 번에 자산의 몇 %를 살까?”를 정하는 **비율표** 만듦
5. **`rebalancing_spec.py`**

   * “가지고 있는 자산을 골고루 유지하려면 어떻게 팔고 살까?” 계산

🟢 요약: **“어떻게 사고팔지”를 미리 정해놓는 머리 역할**이에요.

---

### ⚙️ (3) 시뮬레이션 단계 — **“연습장에 가서 테스트하기”**

1. **`engine.py`**

   * 하루하루 데이터를 훑으며,
     “어제 신호 → 오늘 아침 실행”, “손절 신호 → 먼저 팔기”
     같은 순서대로 **가상 거래 실행**
2. **`execution.py`**

   * 실제 거래처럼 **가격을 반올림(틱)** 하고
     **수수료·세금**도 계산
3. **`outputs.py`**

   * 결과 정리:

     * 거래 기록(`trades`)
     * 자본 곡선(`equity_curve`)
     * 통계(`metrics`)
     * 설정(`run_meta`)
4. **`sizing_on_open.py`**

   * 시가(Open) 기준으로 **몇 주/몇 코인 살지 계산**

🟢 요약: “전략이 잘 작동하는지, 연습장(과거 데이터)에서 시험해보는 단계”예요.

---

### 🧾 (4) 검증 단계 — **“숙제 검사하기”**

1. **`data_gate.py`**

   * 데이터에 빠진 부분, 시간순 오류, 중복이 없는지 체크
2. **`strategy_gate.py`**

   * 전략이 **룰을 어기지 않았는지** (예: 어제 신호인데 오늘이 아닌 그날 바로 거래한 경우) 확인
3. **`simulation_gate.py`**

   * 시뮬레이션이 **수량·수수료·현금 흐름**을 정확히 계산했는지 점검
4. **`analysis_viz.py`**

   * **그림으로 성과 보기**: 자본 곡선, 손익 분포, 드로우다운, 승률 등 그래프로 요약

🟢 요약: “이 연습이 정말 믿을 수 있을까?”를 확인하는 **선생님 단계**예요.

---

### 💰 (5) 실매매 단계 — **“이제 진짜 돈으로 실행!”**

1. **`plan_auto.py`**

   * 매일 아침 자동으로 **오늘의 거래 계획(Plan)** 세움
2. **`order_router.py`**

   * 계획을 **‘팔 것 → 살 것’ 순서로 정렬**하고
     한 계좌에 예산이 부족하면 **비율로 줄여서 주문**
3. **`broker_hub.py`**

   * **증권사(KIS)** 와 **거래소(Upbit)** 를 연결해
     명령을 보내고 시세·잔액·포지션을 가져옴
4. **`broker_adapter*.py`**

   * 실제 API 통신, **인증키 갱신**, **주문 전송**, **체결 조회** 처리
5. **`fills.py`**

   * 거래소에서 **실제로 체결된 기록**을 가져옴
6. **`reconcile.py`**

   * 계획과 실제 체결을 비교해서
     “계획대로 됐나요?”, “빠진 주문 있나요?” 확인
7. **`outputs.py`**

   * **결과를 파일로 남김** (`trades.jsonl`, `equity_curve.csv`, `metrics.json`, `run_meta.json`)

🟢 요약: 백테스트에서 배운 그대로 **진짜 거래를 실행하고 기록하는 단계**예요.

---

## 🔁 4. 전체 흐름 한눈에 보기

```
데이터 수집  →  전략 생성  →  시뮬레이션  →  검증  →  실매매
   ↓                ↓             ↓             ↓          ↓
 깨끗한 가격   언제 사고팔지   연습장에서   잘 작동했는지   진짜 돈으로
 데이터 저장    규칙 정하기     테스트하기     검사하기       실행하기
```
