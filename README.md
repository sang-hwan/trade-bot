# 목표

데이터 → 전략 → 시뮬레이션 → 검증

> 이 문서는 백테스트 파이프라인을 위 순서로 정리해 **실행·재현성·비용 반영**을 일관되게 유지합니다.

**바로가기:** [데이터](#1-데이터) · [전략](#2-전략) · [시뮬레이션](#3-시뮬레이션) · [검증](#4-검증)

---

# 코드 작성 시 주의점
1. 표준 라이브러리 **우선 사용**  
2. **코드 청소**: 동작·출력·공개 API는 그대로 유지한 채, 미사용 import/변수/함수, 주석 처리된 코드, 임시 디버그 출력, 죽은/불필요 분기, 광범위 예외(pass) 등 불필요 요소를 일괄 제거

# 유일하게 허용되는 주석(파일 머리말 템플릿)

```python
"""
<한 줄 요약: 이 파일이 무엇을/왜 수행하는지>

이 파일의 목적:
- (두세 줄로) 핵심 배경과 의도 요약

사용되는 변수와 함수 목록:
- 변수
  - <변수명>: <의미/단위/예시>
- 함수
  - <함수명()>
    - 역할: <한 줄 요약>
    - 입력값: <매개변수: 타입 = 기본값> - <의미/단위/허용범위>
    - 반환값: <타입/형태> - <의미>

파일의 흐름(→ / ->):
- <단계1> -> <단계2> -> <단계3> ...
"""
```

---

## 1) 데이터

### (공통) 기본 데이터 & 품질 체크
- **시간순 정렬·단일 타임존**(예: UTC) 적용  
  - `timestamp` 단조증가, 중복 인덱스 금지, 전 행 대비 음수 간격 금지.
- **결측/중복 제거**, 거래 달력 정합(휴장/주말 처리)  
  - 결측행(NaN) 드롭/보간 기준 고정(가격은 보간 지양, 보유/결정치 필요 구간은 제거).
- **비용·체결 메타데이터**: 수수료, 슬리피지, 호가/로트 단위 *(항목만 유지; 상세 모델화는 후속 단계에서)*
- **백테스트 관례**: 장기 테스트는 **조정종가(Adj Close)** 우선  
  - **완전 조정 OHLC 권장**: 스플릿/배당 영향 반영 일관성을 위해  
    - 보정계수 $a_t=\frac{\text{AdjClose}_t}{\text{Close}_t}$ 로 **O/H/L/C 모두** $X^{\text{adj}}_t=X_t\cdot a_t$ 변환(가능한 소스 사용 또는 자체 보정).
- **체결용 시가 포함**: 룩어헤드 금지 체결 정책(전일 확정 → 익일 체결)을 위해 **`open` 필수**.
- **품질 게이트(예시 체크)**  
  - `open, high, low, close > 0`, 그리고 `low ≤ min(open, close, high) ≤ high`  
  - 연속 구간 충족 전(아래 각 전략의 윈도 요구) **분석/시그널 금지**  
  - **스냅샷 고정**: 원천 데이터는 Parquet(+해시/버전)로 동결해 재현성 확보.

### [SMA10/50 시그널] 가격 시계열 데이터(진입/청산용)
- **필수 데이터**: 종가 시계열 $P_t$ (일봉이면 일일 종가), **체결용 시가 $O_t$**, **연속 관측치 ≥ 50**
- **전처리 가이드**
  - 초기 $\mathrm{SMA}_{50}$ 계산 전까지 **시그널 생성 금지**(불완전 구간 제외).
  - **룩어헤드 금지**: 시점 $t$의 포지션은 $t-1$까지 확정된 $SMA_{10},SMA_{50}$ 비교로만 결정, 체결은 **$t$의 시가 $O_t$**에서 가정.
  - **타이브레이크 규칙 명시**: $\text{diff}=SMA_{10}-SMA_{50}$; **diff $>\ \epsilon$** ⇒ 1(롱), 그 외 0. $\epsilon\ge 0$ 고정.
- **품질 게이트**
  - SMA 계산 대상 구간에 NaN/중복 없음, $SMA_{10},SMA_{50}$ 생성 시점 확인(최초 생성일 로그/마커 남김).
  - 조정 정책 일관: SMA도 **조정 가격(가능하면 완전 조정 Close)** 로 계산.

### [Donchian 스탑] OHLC 데이터(보호 스탑용)
- **필수 데이터**: $H_t, L_t, C_t$ (특히 **저가 $L_t$**), **스탑 윈도 $N$**, 체결용 시가 $O_t$
- **전처리 가이드**
  - 거래일 기준 **연속 $N$개 저가** 확보(결측/중복 제거).  
  - **세션 정합**: 갭(야간/개장) 처리 방침 일관 유지 *(상세 문서화/데이터화는 제외)*.
  - **룩어헤드 금지**: 스탑 임계값은 **$L_N(t-1)$**만 사용, 트리거는 보수적으로 **$L_t \le L_N(t-1)$**.
  - **조정 Low 권장**: 스플릿 보정 일관성 확보를 위해 $L_t^{\text{adj}}$ 사용.
- **품질 게이트**
  - **윈도 경계 확인**: 첫 유효 트리거 가능 시점은 $t \ge N$.  
  - $L_t \le H_t$, 극단치/비정상 바 제거 규칙 고정.  
  - $L_N(t-1)$ 계산 경로(배치/스트리밍) 간 값 일치성 점검.

### [Fixed Fractional 사이징] 계좌·상품 메타데이터
- **필수 데이터**: 계좌 자본 $E$, 위험 비율 $f$(예: 0.01–0.02), **엔트리 가격 $entry=O_t$**, **스탑 가격 $stop= L_N(t-1)$**
- **상품 단위 가치**: 선물 포인트가치 $V$, FX 핍가치 $PV$, **호가/로트 단위** $s$, **포트폴리오 위험 한도** $h_{\max}$
- **전처리 가이드**
  - **통화 일관성**: $R=fE$와 분모(가격거리·포인트가치·핍가치)의 **통화 단위 일치**(계좌통화 기준).
  - **스탑 거리 유효성**: $D=entry-stop>0$ 를 만족하지 않으면 **사이징=0** 처리(무효 트레이드).
  - **라운딩 규칙**: 수량은 **호가/로트 단위 $s$** 에 맞춰 **하향 보정**(미니멈 거래단위 미만이면 0).
  - **자본 갱신**: 트레이드 종료 시 **$E$ 업데이트 규칙**(실현 PnL 반영) 고정.
- **품질 게이트**
  - $E>0, f>0$ 검증, 자산 유형별 단위($V, PV, s$) 음수/0 금지.
  - 수량 산출 후 **비현실적 과대치 캡**(예: 심볼별 최대 허용 로트/노출) 적용.

---

## 2) 전략

### 진입/청산: **SMA10/50 크로스(시그널 기반)**

#### (1) 출처 & 검증 수준 요약
- **계보**: 장·단기 이동평균 교차는 고전 **추세 추종** 규칙, 10/50은 그 한 파라미터.  
- **검증 수준**: 특정 시장·시기 **유효 가능** 보고 있으나 **데이터 스누핑·비용·표본외 성과**로 **항구적 우위 미보장** → **비용 포함 자체 백테스트 + 표본외 검증** 필수.

#### (2) 공식 (LaTeX/MathJax)

**정의**

$$
\mathrm{SMA}_{n}(t)=\frac{1}{n}\sum_{i=0}^{n-1} P_{t-i}
$$

**증분 갱신식** — 이전 평균과 새 값 $P_t$, 창에서 빠지는 값 $P_{t-n}$ 만으로 $O(1)$ 갱신:

$$
\mathrm{SMA}_{n}(t)=\mathrm{SMA}_{n}(t-1)+\frac{P_t-P_{t-n}}{n}
$$

**시그널 규칙 — 룩어헤드 금지**  
$t$ 번째 봉의 체결 판단은 $t-1$ 까지 확정된 정보(예: $\mathrm{SMA}_{n}(t-1)$)만 사용하고, $P_t$ 같은 미래 정보는 배제합니다.

- **진입/보유**: $\mathrm{SMA}_{10}(t-1)>\mathrm{SMA}_{50}(t-1)$ → $t$ 번째 봉에서 진입/보유
- **관망/청산**: $\mathrm{SMA}_{10}(t-1)\le \mathrm{SMA}_{50}(t-1)$ → $t$ 번째 봉에 미보유/청산

> 메모: 10/50은 **절대 최적값 아님**. 자산·레짐·비용에 민감 → 표본외 검증 권장.

---

### 스탑: **Donchian 채널 $N$-일 최저가 이탈(롱 기준)**

#### (1) 출처 & 검증 수준 요약
- **계보**: Richard Donchian의 **Donchian Channels**(1960s)에서 유래, 이후 **Turtle Trading** 등 **CTA/추세추종**에서 보호 스탑·브레이크아웃 기준으로 폭넓게 사용.  
- **검증 수준**: 다양한 자산군·기간에서 **리스크 관리 수단**으로 실무 채택 사례가 많으나, **횡보 구간에선 과도한 청산**이 발생할 수 있음 → **표본외 검증**, **$N$ 민감도 분석**, **비용/슬리피지 반영** 필수.

#### (2) 정의 & 트리거 (룩어헤드 금지)

**$N$-일 최저가(슬라이딩 윈도)**

$$
L_N(t)=\min_{0\le i < N} L_{t-i}
$$

**보호 스탑 트리거(롱)** — **시그널 청산과 병행**, **먼저 발생한 쪽을 우선**

$$
L_t \le L_N(t-1)\ \Rightarrow\ t\text{번째 봉에서 스탑 청산}
$$

- 매 봉마다 $L_N(t-1)$ 을 재계산(포지션 보유 중에도 갱신).  
- (참고) 숏 포지션은 **$N$-일 최고가 상향 이탈**을 대칭적으로 사용.

> 구현 메모: 단순 재계산은 $O(N)$, 대량 데이터는 **단조 큐(모노토닉 deque)** 로 $O(1)$ 기대 갱신 가능.

---

### 사이징: **Fixed Fractional(트레이드당 $f\%$ 위험)**

#### (1) 출처 & 검증 수준 요약
- **계보**: Ralph Vince가 저작(1990s)들에서 **포지션 사이징**을 체계화. “트레이드당 $1$–$2\%$ 위험”은 실무 **관행적 권고치**.  
- **검증 수준**: **생존성·드로우다운 관리**에 실무적 효용이 널리 보고되었으나 **수학적 최적성 보장은 아님** → 자산·전략·비용에 맞춘 $f$ 보정과 **표본외 검증** 권장.

#### (2) 위험 예산

$$
R=f\cdot E
$$

#### (3) 스탑 기반 거리(롱)

- Donchian 임계값으로 스탑을 둘 때,

$$
D=\text{Entry}-L_N(t-1)
$$

#### (4) 수량 공식

- **주식/코인(1단위 가격자산)**

$$
Q=\left\lfloor \frac{R}{D} \right\rfloor
$$

- **선물(포인트가치 $V$)**

$$
Q=\left\lfloor \frac{R}{D\cdot V} \right\rfloor
$$

- **FX(핍가치 $PV$, 스탑 $D_{\mathrm{pips}}$)**

$$
Q=\left\lfloor \frac{R}{D_{\mathrm{pips}}\cdot PV} \right\rfloor
$$

- **실행 수량(호가/로트 단위 보정)**

$$
Q_{\text{exec}}=\Big\lfloor \frac{Q}{s} \Big\rfloor \cdot s
$$

**단위 메모**: $R$과 분모의 단위를 **동일 통화단위**로 해석(주식: $D$, 선물: $D\cdot V$, FX: $D_{\mathrm{pips}}\cdot PV$).

---

---

## 3) 시뮬레이션

### 목표

> 데이터·전략 단계에서 정의된 규칙(신호·스탑·사이징)과 비용 모델을 통합하여, 시간의 흐름에 따라 가상의 거래를 순차적으로 실행하고 그 결과를 기록합니다. 이 과정은 **룩어헤드 편향을 원천 차단**하고 모든 **상태 변화를 명시적으로 추적**하여 재현성을 보장하는 데 초점을 맞춥니다.

### 시뮬레이션 설정

본 MVP 시뮬레이션은 다음과 같은 검증되고 단순화된 규칙을 따릅니다.

* **초기 자본금 ($E_0$)**: **1,000,000원**
* **자본 갱신 정책**: 한 거래가 완전히 **청산될 때만 실현 손익(Realized PnL)을 자본에 반영**합니다. (미실현 손익은 자본 계산에 미포함)
* **수수료 (Commission)**: 모든 체결(진입/청산) 시 **거래대금의 0.05%**를 비용으로 차감합니다. (일반적인 증권사 수수료율 예시)
* **슬리피지 (Slippage)**: 모든 체결 시 주문에 **불리한 방향으로 체결가의 0.05%**를 추가 반영합니다. (매수 시 더 비싸게, 매도 시 더 싸게 체결)
* **체결 가격 정책**: 모든 주문(진입, 시그널 청산, 스탑 청산)은 예외 없이 **다음 봉의 시가(NEXT-OPEN)**에 체결되는 것으로 가정합니다.

### 시뮬레이션 루프 (Bar 단위 이벤트 처리 순서)

시뮬레이션은 각 시점(Bar) `t`를 순회하는 루프를 통해 진행됩니다. 각 `t`에서의 모든 판단과 실행은 **`t-1`까지 확정된 정보**만을 사용합니다.

**`t` 시점의 처리 흐름:**

1.  **`t` 개장 (On-Bar-Open): 상태 확인 및 주문 생성**
    * **계좌 상태 확인**: 직전 시점의 자본($E_{t-1}$), 보유 포지션($Q_{t-1}$)을 확인합니다.
    * **청산 주문 생성**:
        * 현재 포지션을 보유 중($Q_{t-1}>0$)일 경우, `t-1` 정보 기준으로 청산 조건을 확인합니다.
        * **스탑 청산**: `t`의 저가($L_t$)가 스탑 임계값($L_N(t-1)$)을 하회하면(`L_t ≤ L_N(t-1)`) 스탑 청산 주문을 생성합니다.
        * **시그널 청산**: SMA 신호가 `0` (관망/청산)이면 시그널 청산 주문을 생성합니다.
        * **우선순위**: 만약 스탑과 시그널 청산 조건이 동시에 충족되면, **리스크 관리를 위해 스탑 청산을 우선** 처리합니다.
    * **진입 주문 생성**:
        * 현재 포지션이 없고($Q_{t-1}=0$) `t-1` 기준 SMA 신호가 `1`(진입/보유)이면 진입 주문을 생성합니다.
        * **포지션 사이징**: 진입 수량은 **Fixed Fractional 규칙**에 따라 계산됩니다. 만약 계산된 수량이 거래 가능한 최소 단위 미만(예: 0)일 경우, '진입 실패'로 기록하고 주문을 생성하지 않습니다.

2.  **`t` 체결 (Fill Logic): 주문 실행 및 상태 변경**
    * 생성된 주문을 **다음 봉 시가($O_t$)**에 위에서 정의한 **수수료**와 **슬리피지**를 적용하여 체결 처리합니다.
    * 체결 결과를 바탕으로 포지션($Q_t$), 현금, 실현 손익을 계산하여 계좌 상태를 갱신합니다.

3.  **`t` 마감 (On-Bar-Close): 다음 시점을 위한 정보 갱신**
    * `t`의 종가($\text{close}_t$)와 저가($\text{low}_t$) 데이터를 사용하여, `t+1` 시점에서 사용될 SMA 값과 Donchian 최저가 임계값을 갱신합니다.
    * `t` 시점의 모든 이벤트(신호, 주문, 체결, 자본 상태 등)를 **거래 로그(Trade Log)**와 **자산 추이(Equity Curve)** 데이터로 기록합니다.

---

## 4) 검증
- **표본내/표본외 분리**, 워크포워드  
- 민감도: 파라미터 $n$(SMA), $N$(Donchian), $f$(위험 비율)  
- 비용/슬리피지 스트레스 테스트, 최대낙폭·리스크 지표 점검

_기호 메모_: $n$ = SMA 기간, $N$ = Donchian 스탑 기간, $Q$ = 포지션 수량, $V$ = 선물 포인트가치, $PV$ = FX 핍가치
