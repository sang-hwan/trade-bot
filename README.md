# 목표

데이터 → 전략 → 시뮬레이션 → 검증

> 이 문서는 백테스트 파이프라인을 위 순서로 정리해 **실행·재현성·비용 반영**을 일관되게 유지합니다.

**바로가기:** [데이터](#1-데이터) · [전략](#2-전략) · [시뮬레이션](#3-시뮬레이션) · [검증](#4-검증)

---

# 코드 작성 시 주의점
1. 표준 라이브러리 **우선 사용**  
2. **코드 청소**: 동작·출력·공개 API는 그대로 유지한 채, 미사용 import/변수/함수, 주석 처리된 코드, 임시 디버그 출력, 죽은/불필요 분기, 광범위 예외(pass) 등 불필요 요소를 일괄 제거
3. **SSOT(Single Source of Truth) 원칙 준수**: 모든 데이터는 단일 출처에서 관리하여 데이터의 일관성과 무결성을 유지합니다.

---

# 유일하게 허용되는 주석(파일 머리말 템플릿)

```python
"""
<한 줄 요약: 이 파일이 무엇을/왜 수행하는지>

이 파일의 목적:
- (두세 줄로) 핵심 배경과 의도 요약

사용되는 변수와 함수 목록:
- 변수
  - <변수명>: <의미/단위/예시>
- 함수
  - <함수명()>
    - 역할: <한 줄 요약>
    - 입력값: <매개변수: 타입 = 기본값> - <의미/단위/허용범위>
    - 반환값: <타입/형태> - <의미>

파일의 흐름(→ / ->):
- <단계1> -> <단계2> -> <단계3> ...
"""
```

---

## 1) 데이터

### (공통) 기본 데이터 & 품질 체크
- **시간순 정렬·단일 타임존**(예: UTC) 적용  
  - `timestamp` 단조증가, 중복 인덱스 금지, 전 행 대비 음수 간격 금지.
- **결측/중복 제거**, 거래 달력 정합(휴장/주말 처리)  
  - 결측행(NaN) 드롭/보간 기준 고정(가격은 보간 지양, 보유/결정치 필요 구간은 제거).
- **비용·체결 메타데이터**: 수수료, 슬리피지, 호가/로트 단위 *(항목만 유지; 상세 모델화는 후속 단계에서)*
- **백테스트 관례**: 장기 테스트는 **조정종가(Adj Close)** 우선  
  - **완전 조정 OHLC 권장**: 스플릿/배당 영향 반영 일관성을 위해  
    - 보정계수 $a_t=\frac{\text{AdjClose}_t}{\text{Close}_t}$ 로 **O/H/L/C 모두** $X^{\text{adj}}_t=X_t\cdot a_t$ 변환(가능한 소스 사용 또는 자체 보정).
- **체결용 시가 포함**: 룩어헤드 금지 체결 정책(전일 확정 → 익일 체결)을 위해 **`open` 필수**.
- **품질 게이트(예시 체크)**  
  - `open, high, low, close > 0`, 그리고 `low ≤ min(open, close, high) ≤ high`  
  - 연속 구간 충족 전(아래 각 전략의 윈도 요구) **분석/시그널 금지**  
  - **스냅샷 고정**: 원천 데이터는 Parquet(+해시/버전)로 동결해 재현성 확보.

### [SMA10/50 시그널] 가격 시계열 데이터(진입/청산용)
- **필수 데이터**: 종가 시계열 $P_t$ (일봉이면 일일 종가), **체결용 시가 $O_t$**, **연속 관측치 ≥ 50**
- **전처리 가이드**
  - 초기 $\mathrm{SMA}_{50}$ 계산 전까지 **시그널 생성 금지**(불완전 구간 제외).
  - **룩어헤드 금지**: 시점 $t$의 포지션은 $t-1$까지 확정된 $SMA_{10},SMA_{50}$ 비교로만 결정, 체결은 **$t$의 시가 $O_t$**에서 가정.
  - **타이브레이크 규칙 명시**: $\text{diff}=SMA_{10}-SMA_{50}$; **diff $>\ \epsilon$** ⇒ 1(롱), 그 외 0. $\epsilon\ge 0$ 고정.
- **품질 게이트**
  - SMA 계산 대상 구간에 NaN/중복 없음, $SMA_{10},SMA_{50}$ 생성 시점 확인(최초 생성일 로그/마커 남김).
  - 조정 정책 일관: SMA도 **조정 가격(가능하면 완전 조정 Close)** 로 계산.

### [Donchian 스탑] OHLC 데이터(보호 스탑용)
- **필수 데이터**: $H_t, L_t, C_t$ (특히 **저가 $L_t$**), **스탑 윈도 $N$**, 체결용 시가 $O_t$
- **전처리 가이드**
  - 거래일 기준 **연속 $N$개 저가** 확보(결측/중복 제거).  
  - **세션 정합**: 갭(야간/개장) 처리 방침 일관 유지 *(상세 문서화/데이터화는 제외)*.
  - **룩어헤드 금지**: 스탑 임계값은 **$L_N(t-1)$**만 사용, 트리거는 보수적으로 **$L_t \le L_N(t-1)$**.
  - **조정 Low 권장**: 스플릿 보정 일관성 확보를 위해 $L_t^{\text{adj}}$ 사용.
- **품질 게이트**
  - **윈도 경계 확인**: 첫 유효 트리거 가능 시점은 $t \ge N$.  
  - $L_t \le H_t$, 극단치/비정상 바 제거 규칙 고정.  
  - $L_N(t-1)$ 계산 경로(배치/스트리밍) 간 값 일치성 점검.

### [Fixed Fractional 사이징] 계좌·상품 메타데이터
- **필수 데이터**: 계좌 자본 $E$, 위험 비율 $f$(예: 0.01–0.02), **엔트리 가격 $entry=O_t$**, **스탑 가격 $stop= L_N(t-1)$**
- **상품 단위 가치**: 선물 포인트가치 $V$, FX 핍가치 $PV$, **호가/로트 단위** $s$, **포트폴리오 위험 한도** $h_{\max}$
- **전처리 가이드**
  - **통화 일관성**: $R=fE$와 분모(가격거리·포인트가치·핍가치)의 **통화 단위 일치**(계좌통화 기준).
  - **스탑 거리 유효성**: $D=entry-stop>0$ 를 만족하지 않으면 **사이징=0** 처리(무효 트레이드).
  - **라운딩 규칙**: 수량은 **호가/로트 단위 $s$** 에 맞춰 **하향 보정**(미니멈 거래단위 미만이면 0).
  - **자본 갱신**: 트레이드 종료 시 **$E$ 업데이트 규칙**(실현 PnL 반영) 고정.
- **품질 게이트**
  - $E>0, f>0$ 검증, 자산 유형별 단위($V, PV, s$) 음수/0 금지.
  - 수량 산출 후 **비현실적 과대치 캡**(예: 심볼별 최대 허용 로트/노출) 적용.

---

## 2) 전략

### 진입/청산: **SMA10/50 크로스(시그널 기반)**

#### (1) 출처 & 검증 수준 요약
- **계보**: 장·단기 이동평균 교차는 고전 **추세 추종** 규칙, 10/50은 그 한 파라미터.  
- **검증 수준**: 특정 시장·시기 **유효 가능** 보고 있으나 **데이터 스누핑·비용·표본외 성과**로 **항구적 우위 미보장** → **비용 포함 자체 백테스트 + 표본외 검증** 필수.

#### (2) 공식 (LaTeX/MathJax)

**정의**

$$
\mathrm{SMA}_{n}(t)=\frac{1}{n}\sum_{i=0}^{n-1} P_{t-i}
$$

**증분 갱신식** — 이전 평균과 새 값 $P_t$, 창에서 빠지는 값 $P_{t-n}$ 만으로 $O(1)$ 갱신:

$$
\mathrm{SMA}_{n}(t)=\mathrm{SMA}_{n}(t-1)+\frac{P_t-P_{t-n}}{n}
$$

**시그널 규칙 — 룩어헤드 금지**  
$t$ 번째 봉의 체결 판단은 $t-1$ 까지 확정된 정보(예: $\mathrm{SMA}_{n}(t-1)$)만 사용하고, $P_t$ 같은 미래 정보는 배제합니다.

- **진입/보유**: $\mathrm{SMA}_{10}(t-1)>\mathrm{SMA}_{50}(t-1)$ → $t$ 번째 봉에서 진입/보유
- **관망/청산**: $\mathrm{SMA}_{10}(t-1)\le \mathrm{SMA}_{50}(t-1)$ → $t$ 번째 봉에 미보유/청산

> 메모: 10/50은 **절대 최적값 아님**. 자산·레짐·비용에 민감 → 표본외 검증 권장.

---

### 스탑: **Donchian 채널 $N$-일 최저가 이탈(롱 기준)**

#### (1) 출처 & 검증 수준 요약
- **계보**: Richard Donchian의 **Donchian Channels**(1960s)에서 유래, 이후 **Turtle Trading** 등 **CTA/추세추종**에서 보호 스탑·브레이크아웃 기준으로 폭넓게 사용.  
- **검증 수준**: 다양한 자산군·기간에서 **리스크 관리 수단**으로 실무 채택 사례가 많으나, **횡보 구간에선 과도한 청산**이 발생할 수 있음 → **표본외 검증**, **$N$ 민감도 분석**, **비용/슬리피지 반영** 필수.

#### (2) 정의 & 트리거 (룩어헤드 금지)

**$N$-일 최저가(슬라이딩 윈도)**

$$
L_N(t)=\min_{0\le i < N} L_{t-i}
$$

**보호 스탑 트리거(롱)** — **시그널 청산과 병행**, **먼저 발생한 쪽을 우선**

$$
L_t \le L_N(t-1)\ \Rightarrow\ t\text{ 바 종료에 스탑을 판정하고, }t+1\text{ 바 시가(Open)에 청산 주문을 체결}
$$

- 매 봉마다 $L_N(t-1)$ 을 재계산(포지션 보유 중에도 갱신).  
- (참고) 숏 포지션은 **$N$-일 최고가 상향 이탈**을 대칭적으로 사용.

> 구현 메모: 단순 재계산은 $O(N)$, 대량 데이터는 **단조 큐(모노토닉 deque)** 로 $O(1)$ 기대 갱신 가능.

---

### 사이징: **Fixed Fractional(트레이드당 $f\%$ 위험)**

#### (1) 출처 & 검증 수준 요약
- **계보**: Ralph Vince가 저작(1990s)들에서 **포지션 사이징**을 체계화. “트레이드당 $1$–$2\%$ 위험”은 실무 **관행적 권고치**.  
- **검증 수준**: **생존성·드로우다운 관리**에 실무적 효용이 널리 보고되었으나 **수학적 최적성 보장은 아님** → 자산·전략·비용에 맞춘 $f$ 보정과 **표본외 검증** 권장.

#### (2) 위험 예산

$$
R=f\cdot E
$$

#### (3) 스탑 기반 거리(롱)

- Donchian 임계값으로 스탑을 둘 때,

$$
D=\text{Entry}-L_N(t-1)
$$

#### (4) 수량 공식

- **주식/코인(1단위 가격자산)**

$$
Q=\left\lfloor \frac{R}{D} \right\rfloor
$$

- **선물(포인트가치 $V$)**

$$
Q=\left\lfloor \frac{R}{D\cdot V} \right\rfloor
$$

- **FX(핍가치 $PV$, 스탑 $D_{\mathrm{pips}}$)**

$$
Q=\left\lfloor \frac{R}{D_{\mathrm{pips}}\cdot PV} \right\rfloor
$$

- **실행 수량(호가/로트 단위 보정)**

$$
Q_{\text{exec}}=\Big\lfloor \frac{Q}{s} \Big\rfloor \cdot s
$$

**단위 메모**: $R$과 분모의 단위를 **동일 통화단위**로 해석(주식: $D$, 선물: $D\cdot V$, FX: $D_{\mathrm{pips}}\cdot PV$).

---

## 3) 시뮬레이션

### 목표
> 데이터·전략 단계에서 확정된 규칙(신호·스탑·사이징)과 비용 모델을 결합해, 시간 순서대로 거래를 모사하고 결과를 기록합니다. 모든 판단은 **룩어헤드 금지**, 모든 상태 변화는 **명시적 기록**, 모든 입력/출력은 **재현 가능**해야 합니다.

### 구성 요소(역할과 입·출력 계약)
- **데이터 수집 모듈**: 원천에서 지정한 심볼/기간/소스를 읽어 **원본 데이터 참조**와 **소스 메타**를 제공합니다.
- **전처리 모듈**: 원본을 **정렬·중복 제거(keep='last')·품질 게이트**로 정합화하고, 가능하면 **완전 조정 OHLC(`*_adj`)**를 생성하여 **스냅샷(Parquet + 해시/버전)**을 산출합니다.  
  - 이후 단계에서는 **추가 전처리 금지**(정렬/중복/품질 재수행 불가).
- **실행 모듈(전략 기반 백테스트)**: 전처리 스냅샷과 전략 컴포넌트(신호·스탑·사이징)를 받아 **주문 생성·체결·계좌 상태 갱신**을 수행합니다.
- **저장 모듈**: 실행 결과를 **표준 산출물**(거래 로그, 자본 곡선, 핵심 지표, 설정/스냅샷 메타)로 고정합니다.
- **오케스트레이션**: 위 네 단계를 **하나의 실행 흐름**으로 연결하고, 구성(config)과 산출물 경로를 **런 단위로 관리**합니다.

### 시뮬레이션 설정(기본값)
- **초기 자본($E_0$)**: **1,000,000원**
- **자본 갱신**: 포지션이 **완전 청산될 때** 실현 손익을 자본에 반영(미실현 손익은 제외)
- **수수료(Commission)**: 체결마다 **거래대금의 0.05%**
- **슬리피지(Slippage)**: 체결가에 **불리한 방향 0.05%**
- **체결 가격 기준**: 가능하면 **조정 시가(`open_adj`)**, 없으면 `open`을 사용(혼용 금지)

### 의사결정/체결 타임라인(룩어헤드 금지)
- **시그널(진입/청산)**: **Close($t-1$)** 까지의 확정 정보로 **결정** → **Open($t$)** 에 **체결**
- **스탑(보호 청산)**: **Close($t$)** 에서 **판정**: $L_t \le L_N(t-1)$ → **Open($t+1$)** 에 **체결**
- **동시 충돌 규칙**: 동일 체결 시점에 스탑 청산과 시그널 주문이 겹치면 **스탑 청산을 우선**하며, 해당 시점의 시그널 주문은 **억제/취소**합니다.
- **포지션 모델(기본)**: **롱 온리**, 피라미딩 없음, 단일 심볼 **0/1 보유** 상태

### 체결/비용 반영 규칙
- **체결가**: 매수 = $Open \cdot (1+\text{slip})$, 매도 = $Open \cdot (1-\text{slip})$
- **수수료**: $|\text{체결가}| \times \text{수량} \times \text{commission\_rate}$
- **사이징(Fixed Fractional)**: $R=f\cdot E$, 스탑 거리 $D=\text{Entry}-L_N(t-1)$  
  - $D\le 0$ 또는 최소 호가/로트 미만 → **수량 = 0(주문 미생성)**
  - 포트폴리오 위험 상한 $h_{\max}$ 존재 시, **진입 주문 생성 직후** 초과분을 감액/취소

### 루프 단계(요약)
1. **On-Bar-Open**: 전일에 생성된 주문만 **체결**(신규 판단 없음) → 포지션/현금/자본 갱신
2. **On-Bar-Close**:
   - `close_t`로 **SMA** 갱신, **다음 바(t+1) 시그널 결정**
   - `low_t`와 $L_N(t-1)$로 **스탑 판정**(히트 시 t+1 청산 주문 생성)
   - **거래 로그**와 **자본 곡선**에 상태 기록

### 입력/출력 및 실패 처리(계약)
- **입력 스냅샷 필수 컬럼**: `open[_adj]`, `high[_adj]`, `low[_adj]`, `close[_adj]`  
  - 누락·음수·바 불변식 위배 시 **실패**
- **전략 컴포넌트 계약**:
  - 신호: $\epsilon\ge 0$ 타이브레이크, **룩어헤드 금지**
  - 스탑: $L_N(t-1)$(연속 관측 $N$ 충족 후 유효), 판정은 **Close($t$)**
  - 사이징: 통화 단위 일치, **수량 하향 보정**
- **산출물(표준화)**:
  - **거래 로그**: `t_ordered, side, reason(signal|stop), qty, px_fill_adj, fee, slip, pnl_realized, E_after …`
  - **자본 곡선**: `t, E, position, fees_cum, slip_cum, drawdown …`
  - **지표**: 총수익, MDD, 승률/페이오프, 샤프 등
  - **구성/스냅샷 메타**: 실행 설정, 데이터 해시/버전

### 오케스트레이션(실행 흐름)
> **수집 → 전처리 → 실행 → 저장**을 하나의 런으로 관리합니다. 각 단계의 입력은 **직전 단계 산출물**만 사용하며, 전처리 이후에는 어떤 단계에서도 **정렬/중복 제거/품질 게이트를 재수행하지 않습니다.** 런별 산출물은 고정된 디렉터리 구조로 보관하여 **재현성·추적성**을 확보합니다.

---

## 4) 검증
- **표본내/표본외 분리**, 워크포워드  
- 민감도: 파라미터 $n$(SMA), $N$(Donchian), $f$(위험 비율)  
- 비용/슬리피지 스트레스 테스트, 최대낙폭·리스크 지표 점검

_기호 메모_: $n$ = SMA 기간, $N$ = Donchian 스탑 기간, $Q$ = 포지션 수량, $V$ = 선물 포인트가치, $PV$ = FX 핍가치
